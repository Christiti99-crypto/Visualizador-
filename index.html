<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Estad√≠sticas VP y Gastos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: #666;
            -webkit-text-fill-color: #666;
        }

        .status-section {
            display: none; /* Ocultar secci√≥n de estado */
        }

        .scenario {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .scenario.loaded {
            border-color: #4CAF50;
            box-shadow: 0 15px 35px rgba(76, 175, 80, 0.2);
        }

        .scenario.loading {
            border-color: #FF9800;
            box-shadow: 0 15px 35px rgba(255, 152, 0, 0.2);
        }

        .scenario.error {
            border-color: #f44336;
            box-shadow: 0 15px 35px rgba(244, 67, 54, 0.2);
        }

        .scenario h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .file-status {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .file-loaded {
            background: #e7f5e7;
            color: #2d7d2d;
            border: 1px solid #b3d9b3;
        }

        .file-loading {
            background: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffcc02;
        }

        .file-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        .controls h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.2rem;
            text-align: center;
        }

        .control-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        select, button {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select {
            background: white;
            min-width: 250px;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .refresh-btn {
            /* Eliminado - ya no se usa */
        }

        .tables-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .table-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        .table-gastos-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .table-gastos-container .comparison-table {
            margin-top: 0;
        }

        .table-gastos-container .comparison-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8f9fa;
        }

        .table-gastos-container .comparison-table th {
            background-color: #f8f9fa !important;
            border-bottom: 2px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            opacity: 1 !important;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        .table-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            font-weight: 600;
        }

        .table-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .comparison-table th, .comparison-table td {
            border: 1px solid #e0e0e0;
            padding: 10px 12px;
            text-align: center;
        }

        .comparison-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .comparison-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .comparison-table tr:hover {
            background-color: #e6f7ff;
        }

        .comparison-table .gad-column {
            background-color: #e3f2fd;
            font-weight: 600;
            text-align: left;
        }

        .comparison-table .year-column {
            background-color: #fff3e0;
            font-weight: 500;
        }

        .hidden {
            display: none;
        }

        .loading-indicator {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.1rem;
        }

        .summary-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .summary-stats h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .summary-stats p {
            margin: 5px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        @media (max-width: 1200px) {
            .status-section {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Comparador VP y Gastos por Escenarios</h1>
            <p>An√°lisis comparativo de Valor Presente (vp10_25) y Variables de Gastos por GAD - Original vs FC+Original vs FC+Funci√≥n</p>
        </div>

        <div class="status-section">
            <div class="scenario" id="scenario-original">
                <h3>üìä Escenario 1: Original</h3>
                <div class="file-status" id="status-original-vp">
                    üìÇ Data VP Original (244): Cargando...
                </div>
                <div class="file-status" id="status-original-gastos">
                    üìÇ Data Gastos Original (3172): Cargando...
                </div>
            </div>

            <div class="scenario" id="scenario-fc-original">
                <h3>üîß Escenario 2: FC + Original</h3>
                <div class="file-status" id="status-fc-original-vp">
                    üìÇ Data VP FC Original (244): Cargando...
                </div>
                <div class="file-status" id="status-fc-original-gastos">
                    üìÇ Data Gastos FC (3172): Cargando...
                </div>
            </div>

            <div class="scenario" id="scenario-fc-function">
                <h3>‚ö° Escenario 3: FC + Funci√≥n</h3>
                <div class="file-status" id="status-fc-function-vp">
                    üìÇ Data VP FC Funci√≥n (244): Cargando...
                </div>
                <div class="file-status" id="status-fc-function-gastos">
                    üìÇ Data Gastos FC E3 (3172): Cargando...
                </div>
            </div>
        </div>

        <div class="controls">
            <h3>üéõÔ∏è Controles de Visualizaci√≥n</h3>
            <div class="control-group">
                <select id="gadSelect">
                    <option value="">Selecciona un GAD para filtrar</option>
                </select>
                <button id="generateComparison" disabled>Generar Tablas Comparativas</button>
            </div>
        </div>

        <div id="visualizationArea" class="hidden">
            <div class="tables-container">
                <div class="table-section">
                    <div class="table-header">
                        <h3>üìà Comparaci√≥n VP (vp10_25) por GAD</h3>
                    </div>
                    <div id="tableVPContainer">
                        <div class="loading-indicator">Generando tabla...</div>
                    </div>
                    <div id="summaryVP" class="summary-stats hidden">
                        <h4>üìä Estad√≠sticas Resumen VP</h4>
                        <div id="statsVPContent"></div>
                    </div>
                </div>

                <div class="table-section">
                    <div class="table-header">
                        <h3>üìä Comparaci√≥n Gastos por GAD y A√±o</h3>
                    </div>
                    <div class="table-gastos-container" id="tableGastosContainer">
                        <div class="loading-indicator">Generando tabla...</div>
                    </div>
                    <div id="summaryGastos" class="summary-stats hidden">
                        <h4>üìä Estad√≠sticas Resumen Gastos</h4>
                        <div id="statsGastosContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de rutas de archivos - ACTUALIZADA
        const FILE_PATHS = {
            vp: {
                original: 'BDD/Escenario Original/Data_VP_Original.xlsx',
                fc_original: 'BDD/2) Escenario FC + Original/Data_Valor_Presente_Escenario2.xlsx',
                fc_function: 'BDD/3) FC + Funcion Cupos/Data_Valor_Presente_Escenario3.xlsx'
            },
            gastos: {
                original: 'BDD/Escenario Original/Data_Gastos_Original.xlsx',
                fc_original: 'BDD/2) Escenario FC + Original/Data_VP_Larga_Escenario2.xlsx',
                fc_function: 'BDD/3) FC + Funcion Cupos/Data_VP_Larga_Escenario3.xlsx'
            }
        };

        // Variables globales para almacenar los datos
        let vpDataStore = {
            original: null,
            fc_original: null,
            fc_function: null
        };

        let gastosDataStore = {
            original: null,
            fc_original: null,
            fc_function: null
        };

        let availableGads = new Set();

        // Configurar event listeners
        document.getElementById('generateComparison').addEventListener('click', generateBothTables);
        document.getElementById('gadSelect').addEventListener('change', checkIfReadyToGenerate);

        // Cargar datos autom√°ticamente al iniciar
        window.addEventListener('load', loadAllData);

        async function loadAllData() {
            console.log('Iniciando carga de datos VP y Gastos...');
            
            availableGads.clear();
            updateAllScenariosStatus('loading');
            document.getElementById('generateComparison').disabled = true;
            document.getElementById('visualizationArea').classList.add('hidden');

            const loadPromises = [];
            
            // Cargar archivos VP
            for (const [scenario, path] of Object.entries(FILE_PATHS.vp)) {
                loadPromises.push(loadFile('vp', scenario, path));
            }
            
            // Cargar archivos Gastos
            for (const [scenario, path] of Object.entries(FILE_PATHS.gastos)) {
                loadPromises.push(loadFile('gastos', scenario, path));
            }
            
            // Esperar a que todos los archivos se carguen
            await Promise.allSettled(loadPromises);
            
            // Actualizar GADs disponibles
            updateGadSelect();
            checkIfReadyToGenerate();
        }

        async function loadFile(type, scenario, path) {
            const statusId = `status-${scenario.replace('_', '-')}-${type}`;
            
            try {
                updateFileStatus(statusId, 'loading', `üìÇ Data ${type.toUpperCase()} ${scenario}: Cargando...`);
                
                console.log(`Cargando ${type}: ${path}`);
                
                const response = await fetch(path);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const data = readExcelFromBuffer(arrayBuffer);
                
                if (type === 'vp') {
                    vpDataStore[scenario] = data;
                } else {
                    gastosDataStore[scenario] = data;
                }
                
                // Actualizar GADs disponibles
                if (data.length > 0) {
                    data.forEach(row => {
                        const gadValue = row.gad || row.GAD;
                        if (gadValue !== undefined && gadValue !== null && gadValue.toString().trim() !== '') {
                            availableGads.add(gadValue.toString().trim());
                        }
                    });
                }
                
                updateFileStatus(statusId, 'loaded', `‚úÖ Data ${type.toUpperCase()} ${scenario}: ${data.length} registros`);
                updateScenarioStatus(scenario, 'loaded');
                
                console.log(`‚úÖ ${type} cargado: ${path} (${data.length} registros)`);
                
            } catch (error) {
                console.error(`‚ùå Error cargando ${type} ${path}:`, error);
                updateFileStatus(statusId, 'error', `‚ùå Data ${type.toUpperCase()} ${scenario}: Error - ${error.message}`);
                updateScenarioStatus(scenario, 'error');
            }
        }

        function readExcelFromBuffer(arrayBuffer) {
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            return XLSX.utils.sheet_to_json(firstSheet);
        }

        function updateFileStatus(statusId, type, message) {
            const element = document.getElementById(statusId);
            if (element) {
                element.textContent = message;
                element.className = `file-status file-${type}`;
            }
        }

        function updateScenarioStatus(scenario, status) {
            const scenarioElement = document.getElementById(`scenario-${scenario.replace('_', '-')}`);
            if (scenarioElement) {
                scenarioElement.classList.remove('loading', 'loaded', 'error');
                scenarioElement.classList.add(status);
            }
        }

        function updateAllScenariosStatus(status) {
            ['original', 'fc-original', 'fc-function'].forEach(scenario => {
                const element = document.getElementById(`scenario-${scenario}`);
                if (element) {
                    element.classList.remove('loading', 'loaded', 'error');
                    element.classList.add(status);
                }
            });
        }

        function updateGadSelect() {
            const select = document.getElementById('gadSelect');
            select.innerHTML = '<option value="">Selecciona un GAD para filtrar</option>';

            const sortedGads = Array.from(availableGads).sort();
            sortedGads.forEach(gad => {
                const option = document.createElement('option');
                option.value = gad;
                option.textContent = gad;
                select.appendChild(option);
            });
            
            console.log(`GADs disponibles: ${sortedGads.join(', ')}`);
        }

        function checkIfReadyToGenerate() {
            const selectedGad = document.getElementById('gadSelect').value;
            const hasVPData = Object.values(vpDataStore).some(data => data !== null && data.length > 0);
            const hasGastosData = Object.values(gastosDataStore).some(data => data !== null && data.length > 0);

            const button = document.getElementById('generateComparison');
            button.disabled = !hasVPData || !hasGastosData || !selectedGad;
            
            if (button.disabled) {
                console.log('Bot√≥n deshabilitado: Faltan datos o GAD no seleccionado');
            } else {
                console.log('‚úÖ Datos y GAD listos para generar tablas comparativas');
            }
        }

        function generateBothTables() {
            const selectedGad = document.getElementById('gadSelect').value;
            
            if (!selectedGad) {
                alert('Por favor selecciona un GAD para filtrar los datos.');
                return;
            }
            
            console.log(`Generando tablas comparativas para GAD: ${selectedGad}`);
            
            // Mostrar √°rea de visualizaci√≥n
            document.getElementById('visualizationArea').classList.remove('hidden');
            
            // Generar tabla VP
            generateVPTable(selectedGad);
            
            // Generar tabla Gastos
            generateGastosTable(selectedGad);
        }

        function generateVPTable(selectedGad) {
            const tableContainer = document.getElementById('tableVPContainer');
            tableContainer.innerHTML = '';

            const table = document.createElement('table');
            table.classList.add('comparison-table');

            // Crear encabezado
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            headerRow.insertCell().textContent = 'GAD';
            headerRow.insertCell().textContent = 'Original (vp10_25)';
            headerRow.insertCell().textContent = 'FC + Original (vp10_25)';
            headerRow.insertCell().textContent = 'FC + Funci√≥n (vp10_25)';

            // Crear cuerpo de la tabla
            const tbody = table.createTBody();
            const scenarios = ['original', 'fc_original', 'fc_function'];
            
            const row = tbody.insertRow();
            const gadCell = row.insertCell();
            gadCell.textContent = selectedGad;
            gadCell.classList.add('gad-column');

            let stats = {
                original: null,
                fc_original: null,
                fc_function: null
            };

            scenarios.forEach(scenario => {
                const cell = row.insertCell();
                const data = vpDataStore[scenario];
                
                if (data && data.length > 0) {
                    const gadData = data.find(row => {
                        const gadValue = row.gad || row.GAD;
                        return gadValue?.toString().trim() === selectedGad;
                    });

                    if (gadData && gadData.hasOwnProperty('vp10_25') && gadData['vp10_25'] !== null && gadData['vp10_25'] !== undefined) {
                        const value = parseFloat(gadData['vp10_25']);
                        if (!isNaN(value)) {
                            cell.textContent = value.toLocaleString('es-ES', { 
                                minimumFractionDigits: 2, 
                                maximumFractionDigits: 2 
                            });
                            stats[scenario] = value;
                        } else {
                            cell.textContent = 'N/A';
                        }
                    } else {
                        cell.textContent = 'N/A';
                    }
                } else {
                    cell.textContent = 'Sin datos';
                }
            });

            tableContainer.appendChild(table);
            
            // Mostrar estad√≠sticas resumen VP
            generateVPSummaryStats(stats);
        }

        function generateGastosTable(selectedGad) {
            const tableContainer = document.getElementById('tableGastosContainer');
            tableContainer.innerHTML = '';

            const table = document.createElement('table');
            table.classList.add('comparison-table');

            // Variables a mostrar para gastos (sin incluir 'anho' como variable)
            const gastosVariables = ['ing_pred2', 'g1_pred', 'g2_pred'];
            const variableNames = {
                'ing_pred2': 'Ing. Pred. 2',
                'g1_pred': 'G1 Pred.',
                'g2_pred': 'G2 Pred.'
            };

            // Crear encabezado
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            headerRow.insertCell().textContent = 'Variable';
            headerRow.insertCell().textContent = 'Original';
            headerRow.insertCell().textContent = 'FC + Original';
            headerRow.insertCell().textContent = 'FC + Funci√≥n';

            // Crear cuerpo de la tabla
            const tbody = table.createTBody();
            const scenarios = ['original', 'fc_original', 'fc_function'];

            // Obtener datos del GAD seleccionado para cada escenario
            let gadDataByScenario = {};
            scenarios.forEach(scenario => {
                const data = gastosDataStore[scenario];
                if (data && data.length > 0) {
                    gadDataByScenario[scenario] = data.filter(row => {
                        const gadValue = row.gad || row.GAD;
                        return gadValue?.toString().trim() === selectedGad;
                    });
                } else {
                    gadDataByScenario[scenario] = [];
                }
            });

            // Obtener todos los a√±os √∫nicos para el GAD seleccionado
            let allYears = new Set();
            scenarios.forEach(scenario => {
                if (gadDataByScenario[scenario]) {
                    gadDataByScenario[scenario].forEach(row => {
                        if (row.anho !== undefined && row.anho !== null) {
                            allYears.add(row.anho.toString());
                        }
                    });
                }
            });

            const sortedYears = Array.from(allYears).sort();

            if (sortedYears.length === 0) {
                const noDataRow = tbody.insertRow();
                const noDataCell = noDataRow.insertCell();
                noDataCell.colSpan = 4;
                noDataCell.textContent = `No se encontraron datos para el GAD: ${selectedGad}`;
                noDataCell.classList.add('no-data-message');
            } else {
                // Crear filas para cada a√±o y variable
                sortedYears.forEach(year => {
                    // Crear una fila separadora para el a√±o
                    const yearRow = tbody.insertRow();
                    const yearCell = yearRow.insertCell();
                    yearCell.colSpan = 4;
                    yearCell.textContent = `A√ëO ${year}`;
                    yearCell.style.backgroundColor = '#e3f2fd';
                    yearCell.style.fontWeight = 'bold';
                    yearCell.style.textAlign = 'center';
                    yearCell.style.padding = '15px';

                    // Crear filas para cada variable de gastos (SIN incluir 'anho')
                    gastosVariables.forEach(variable => {
                        const row = tbody.insertRow();
                        const varCell = row.insertCell();
                        varCell.textContent = variableNames[variable];
                        varCell.style.fontWeight = '600';
                        varCell.style.backgroundColor = '#f5f5f5';

                        scenarios.forEach(scenario => {
                            const cell = row.insertCell();
                            const yearData = gadDataByScenario[scenario].find(row => 
                                row.anho?.toString() === year
                            );

                            if (yearData && yearData.hasOwnProperty(variable) && yearData[variable] !== null && yearData[variable] !== undefined) {
                                const value = parseFloat(yearData[variable]);
                                if (!isNaN(value)) {
                                    cell.textContent = value.toLocaleString('es-ES', { 
                                        minimumFractionDigits: 2, 
                                        maximumFractionDigits: 2 
                                    });
                                } else {
                                    cell.textContent = yearData[variable];
                                }
                            } else {
                                cell.textContent = 'N/A';
                            }
                        });
                    });
                });
            }

            tableContainer.appendChild(table);
            
            // Mostrar estad√≠sticas resumen Gastos
            generateGastosSummaryStats(gadDataByScenario, sortedYears);
        }

        function generateVPSummaryStats(stats) {
            const summaryDiv = document.getElementById('summaryVP');
            const statsContent = document.getElementById('statsVPContent');
            
            let statsHtml = '';
            const scenarios = ['original', 'fc_original', 'fc_function'];
            const scenarioNames = ['Original', 'FC + Original', 'FC + Funci√≥n'];
            
            scenarios.forEach((scenario, index) => {
                const value = stats[scenario];
                if (value !== null && value !== undefined) {
                    statsHtml += `
                        <p><strong>${scenarioNames[index]}:</strong> 
                        ${value.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                    `;
                } else {
                    statsHtml += `
                        <p><strong>${scenarioNames[index]}:</strong> Sin datos</p>
                    `;
                }
            });
            
            statsContent.innerHTML = statsHtml;
            summaryDiv.classList.remove('hidden');
        }

        function generateGastosSummaryStats(gadDataByScenario, sortedYears) {
            const summaryDiv = document.getElementById('summaryGastos');
            const statsContent = document.getElementById('statsGastosContent');
            
            let statsHtml = `<p><strong>GAD analizado:</strong> ${document.getElementById('gadSelect').value}</p>`;
            statsHtml += `<p><strong>A√±os disponibles:</strong> ${sortedYears.join(', ')}</p>`;
            
            const scenarios = ['original', 'fc_original', 'fc_function'];
            const scenarioNames = ['Original', 'FC + Original', 'FC + Funci√≥n'];
            
            scenarios.forEach((scenario, index) => {
                const dataCount = gadDataByScenario[scenario] ? gadDataByScenario[scenario].length : 0;
                statsHtml += `<p><strong>${scenarioNames[index]}:</strong> ${dataCount} registros</p>`;
            });
            
            statsContent.innerHTML = statsHtml;
            summaryDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>
